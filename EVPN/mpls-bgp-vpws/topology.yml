message: |
  This lab builds an MPLS L2 VPN (VPWS RFC8214 aka Kompella) using BGP across PE-routers 
  All hosts connected to VLAN 1000 (ce10-ce60) should be able to ping each other.

  see https://documentation.nokia.com/cgi-bin/dbaccessfilename.cgi/3HE14991AAAHTQZZA01_V1_7450%20ESS%207750%20SR%207950%20XRS%20Advanced%20Configuration%20Guide%20for%20Releases%20up%20to%2022.7.R1-Part%20II.pdf
  page 425

provider: clab

defaults.device: sros

plugin: [ epipe, vpls ] # Defines the 'epipe' type service

bgp.as: 65000

mpls.ldp: True # default

vlans:
  core:
    id: 1
    mode: bridge
  tenant:
    mode: bridge

# evpn.vlans: [ evpn-epipe ] # Currently not set automatically

services:
 epipe-1:
  id: 1
  type: epipe
 epipe-2:
  id: 2
  type: epipe
 # no-type:
 # id: 3
 mpls-vpls-1:
  id: 3
  type: vpls

 # Test
 # vxlan-1:
 #  id: 4
 #  type: vxlan # epipe
 #  evpn.evi: 1234 # only for 'vxlan' type service

groups:
  hosts:
    members: [ ce10, ce20, ce60 ]
    device: linux
  core:
    members: [ pe2, pe3, pe4, pe5 ]
    module: [ bgp, isis, mpls, vlan, evpn, service ]
    config: [ sdp-epipe.j2 ]
  mtu:
    members: [ mtu1, mtu6 ]

nodes: 
 mtu1:
  module: [ mpls, vlan, service ]
  mpls.ldp: False
 pe2:
  bgp.rr: True
  clab.type: sr-1s
 pe3:
 pe4:
 pe5:
 mtu6:
  module: [ isis, mpls, service ]
  # clab.image: vrnetlab/vr-sros:22.10.R1
 ce10:
 ce20:
 ce60:

links:
- ce10:
  mtu1:
   service:
    mpls-vpls-1:
     sap-id: 1
  # vlan.access: tenant
  pool: l2only
- ce20:
  pe2:
   service: 
    epipe-1: # static epipe, no EVPN
     sap-id: 1 # Instead of an access VLAN
  # vlan.access: tenant
  pool: l2only
- mtu1:
   service:
    mpls-vpls-1:
     spoke-sdp: 2
  pe2:
   service: 
    epipe-1: # Can use string for single plain service ref? Hard
  # vlan.access: core # Using 'tenant' causes the epipe link attribute to get lost
- mtu1:
   service:
    mpls-vpls-1:
     spoke-sdp: 3
  pe3:
  vlan.access: tenant
- pe2-pe3
- pe2:
   service:
    epipe-1:
     evpn.eth_tag: 220
    epipe-2:
     evpn.eth_tag: 221
  pe4:
   service:
    epipe-1:
     evpn.eth_tag: 26
    epipe-2:
     evpn.eth_tag: 27

- pe2-pe5
- pe3-pe4
- pe3-pe5
- pe4:
   service: 
    epipe-1: # static epipe, no EVPN
     spoke-sdp: 1
  mtu6:
   service: 
    epipe-1: # TODO VPLS
  # No access VLAN -> SDP
- pe5-mtu6
- mtu6:
  ce60:
  pool: l2only
