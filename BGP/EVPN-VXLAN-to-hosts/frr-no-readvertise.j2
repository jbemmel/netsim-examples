
route-map prevent-double-leaking deny 1
 ! Avoid passing on leaked connected routes via internet vrf to other customer vrfs
 match tag 1
exit
route-map prevent-double-leaking permit 2
 ! Avoid replacing tag 2 on leaked evpn routes with tag 1
 match tag 2
exit
route-map prevent-double-leaking permit 11
 match source-protocol connected
 set tag 1
exit

{% for vname in vrfs %}
router bgp {{ bgp.as }} vrf {{ vname }}

 address-family ipv4 unicast
  import vrf route-map prevent-double-leaking
 exit-address-family
 !
exit
!
{% endfor %}

{# Configure EVPN export route-map to block advertisement of leaked prefixes to EVPN peers #}
{% set _id = (bgp.router_id|ipaddr('address')).split('.')[3] %}
route-map only-direct-connected-routes permit 1
 description "Permit and mark leaked connected routes"
 match tag 1
 set community {{ _id }}:1 additive
exit
route-map only-direct-connected-routes deny 2
 description "Drop evpn routes received from peers"
 match tag 2
exit
route-map only-direct-connected-routes permit 3
 match source-protocol connected
 set community {{ _id }}:3 additive
exit
route-map only-direct-connected-routes deny 4
exit

route-map tag-evpn-in permit 1
 set tag 2
exit

router bgp {{ bgp.as }}
 address-family l2vpn evpn
{% for n in bgp.neighbors if n.evpn|default(False) %}
  neighbor {{ n.ipv4 if n.ipv4 is string else n.local_if }} route-map only-direct-connected-routes out
  neighbor {{ n.ipv4 if n.ipv4 is string else n.local_if }} route-map tag-evpn-in in
{% endfor %}
 exit-address-family
exit
