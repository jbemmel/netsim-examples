
route-map prevent-double-leaking deny 1
 ! Avoid passing on leaked connected routes via internet vrf to other customer vrfs
 match tag 1
exit
route-map prevent-double-leaking permit 2
 set tag 1
exit

{% for vname in vrfs %}
router bgp {{ bgp.as }} vrf {{ vname }}

 address-family ipv4 unicast
  import vrf route-map prevent-double-leaking
 exit-address-family
 !
exit
!
{% endfor %}

{# Configure EVPN export route-map to block advertisement of leaked prefixes to EVPN peers #}
route-map only-direct-connected-routes permit 1
 description "Permit and mark leaked connected routes and routes from Internet vrf"
 match tag 1
 set community 1:1 additive
exit
route-map only-direct-connected-routes permit 2
 match source-protocol connected
 set community 2:2 additive
exit
route-map only-direct-connected-routes permit 3
 set community 3:3 additive
exit

router bgp {{ bgp.as }}
 address-family l2vpn evpn
{% for n in bgp.neighbors if n.evpn|default(False) %}
  neighbor {{ n.ipv4 if n.ipv4 is string else n.local_if }} route-map only-direct-connected-routes out
{% endfor %}
 exit-address-family
exit
