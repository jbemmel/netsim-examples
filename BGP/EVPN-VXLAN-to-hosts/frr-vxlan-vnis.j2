#!/bin/bash
#
set -e
set -x

# Create l3 vni
for vni in {{ evpn.internet_vni }}; do
ip link add br${vni} type bridge
ip link add vxlan${vni} type vxlan id ${vni} local {{ loopback.ipv4|ipaddr('address') }} dstport 4789 nolearning
ip link set br${vni} up
ip link set vxlan${vni} up
ip link set vxlan${vni} master br${vni}
# ip link set dev br${vni} address 00:00:01:02:03:04

# Create external routed vrf
ip link add evpn-vrf type vrf table ${vni} # auto does not work
ip link set evpn-vrf up
ip link set br${vni} master evpn-vrf
done

#
# Create VXLAN interface(s), TODO use 'vni' attribute in subnets
#
for vni in {{ evpn.vxlan_vnis|join(' ') }}; do
    # Create VXLAN interface
    ip link add vxlan${vni} type vxlan \
        id ${vni} \
        dstport 4789 \
        local {{ loopback.ipv4|ipaddr('address') }} \
        nolearning
    # Create companion bridge
    brctl addbr br${vni}
    brctl addif br${vni} vxlan${vni}
    brctl stp br${vni} off
    ip link set up dev br${vni}
    ip link set up dev vxlan${vni}

    # Add to VRF
    ip link set br${vni} master evpn-vrf

    # Attach loopback interface (could assign IP)
    ip addr add dev br${vni} 10.${vni}.0.{{id+100}}/24
    #ip link add link lo0 name lo0.${vni} type vlan id ${vni}
    #brctl addif br${vni} lo0.${vni}
    #ip link set up dev lo0.${vni}
done



# Reload FRR to advertise VNIs
if [[ -f /etc/frr/frr.conf ]]; then
  /usr/lib/frr/frrinit.sh reload
fi

exit 0
